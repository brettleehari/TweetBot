<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Trading Dashboard</title>
    <!-- Chart.js will be loaded from local or implemented as simple Canvas chart -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        body {
            background: #000;
            color: #00ff00;
            padding: 20px;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            background: rgba(0, 255, 0, 0.05);
        }

        .dashboard-header {
            text-align: center;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 5px;
        }

        .price-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 20px;
        }

        .current-price {
            border: 1px solid #00ff00;
            padding: 15px;
            border-radius: 5px;
            background: rgba(0, 255, 0, 0.1);
        }

        .price-value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff00;
            margin: 10px 0;
        }

        .price-change {
            font-size: 16px;
            margin-top: 5px;
        }

        .price-change.positive { color: #00ff00; }
        .price-change.negative { color: #ff0000; }

        .portfolio-section {
            border: 1px solid #00ff00;
            padding: 15px;
            border-radius: 5px;
            background: rgba(0, 255, 0, 0.1);
        }

        .portfolio-breakdown {
            font-size: 14px;
            line-height: 1.6;
            margin-top: 10px;
        }

        .chart-section {
            margin: 20px 0;
            border: 1px solid #00ff00;
            padding: 20px;
            border-radius: 5px;
            background: rgba(0, 255, 0, 0.1);
        }

        .chart-container {
            height: 300px;
            width: 100%;
        }

        .decisions-section {
            border: 1px solid #00ff00;
            padding: 20px;
            border-radius: 5px;
            background: rgba(0, 255, 0, 0.1);
        }

        .decisions-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff00;
        }

        .decisions-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
        }

        .decision-entry {
            border: 1px solid #333;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
            background: rgba(0, 255, 0, 0.05);
        }

        .decision-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .decision-type {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .decision-type.buy { 
            background: #00ff00; 
            color: #000; 
        }

        .decision-type.sell { 
            background: #ff0000; 
            color: #fff; 
        }

        .decision-type.neutral { 
            background: #666; 
            color: #fff; 
        }

        .decision-details {
            font-size: 14px;
            margin: 8px 0;
        }

        .decision-reasoning {
            font-size: 12px;
            color: #ccc;
            margin-top: 10px;
            line-height: 1.4;
        }

        .confidence {
            color: #ffff00;
            font-weight: bold;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff00;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .separator {
            border-bottom: 1px solid #333;
            margin: 8px 0;
        }

        .load-more-btn {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin-top: 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }

        .load-more-btn:hover {
            background: #00cc00;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">BITCOIN TRADING DASHBOARD</div>
        </div>

        <!-- Price and Portfolio Section -->
        <div class="price-section">
            <div class="current-price">
                <div>Current BTC Price: <span class="price-value" id="btc-price">$105,432.50</span></div>
                <div class="price-change" id="price-change">↑ (+2.3%)</div>
                <div style="font-size: 12px; color: #999; margin-top: 10px;">
                    <span class="status-indicator"></span>Live updates every 30s
                </div>
            </div>

            <div class="portfolio-section">
                <div>Portfolio Value: <span class="price-value" id="portfolio-value">$10,847.23</span></div>
                <div class="portfolio-breakdown" id="portfolio-breakdown">
                    (Cash: $3,200.00 + BTC: 0.0725 × $105,432.50 = $7,647.23)
                </div>
                <div style="font-size: 12px; color: #999; margin-top: 10px;">
                    Initial Capital: $10,000.00 | P&L: <span id="portfolio-pnl">+$847.23 (+8.47%)</span>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <div style="margin-bottom: 15px; font-weight: bold;">PORTFOLIO VALUE CHART</div>
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Decision History Section -->
        <div class="decisions-section">
            <div class="decisions-header">DECISION HISTORY (Scrollable)</div>
            <div class="decisions-container" id="decisions-container">
                <!-- Decision entries will be populated here -->
            </div>
            <button class="load-more-btn" onclick="loadMoreDecisions()">Load More History...</button>
        </div>
    </div>

    <script>
        // Portfolio state
        let portfolio = {
            cash: 3200.00,
            btcHoldings: 0.0725,
            initialCapital: 10000.00,
            currentBtcPrice: 105432.50
        };

        // Chart instance  
        let portfolioChart;
        let portfolioData = [];

        // Decision history
        let decisions = [];

        // Initialize dashboard
        function initializeDashboard() {
            loadPortfolioData();
            loadDecisionHistory();
            initializeSimpleChart();
            
            // Start auto-refresh every 30 seconds
            setInterval(() => {
                loadPortfolioData();
                updateChart();
            }, 30000);
        }

        async function loadPortfolioData() {
            try {
                // Load real Bitcoin price
                const priceResponse = await fetch('/api/bitcoin-price');
                const priceData = await priceResponse.json();
                
                if (priceData.success) {
                    portfolio.currentBtcPrice = priceData.data.price;
                    
                    // Update price display
                    document.getElementById('btc-price').textContent = 
                        `$${portfolio.currentBtcPrice.toLocaleString(undefined, {maximumFractionDigits: 2})}`;
                    
                    const changeElement = document.getElementById('price-change');
                    const change24h = priceData.data.change24h;
                    const changeSymbol = change24h >= 0 ? '↑' : '↓';
                    const changeClass = change24h >= 0 ? 'positive' : 'negative';
                    
                    changeElement.textContent = `${changeSymbol} (${change24h >= 0 ? '+' : ''}${change24h.toFixed(1)}%)`;
                    changeElement.className = `price-change ${changeClass}`;
                }

                // Load portfolio data
                const portfolioResponse = await fetch('/api/portfolio');
                const portfolioDataResult = await portfolioResponse.json();
                
                if (portfolioDataResult.success) {
                    const data = portfolioDataResult.data;
                    portfolio.cash = data.cash;
                    portfolio.btcHoldings = data.btcHoldings;
                    
                    // Update portfolio display
                    document.getElementById('portfolio-value').textContent = 
                        `$${data.totalValue.toLocaleString(undefined, {maximumFractionDigits: 2})}`;
                    
                    document.getElementById('portfolio-breakdown').textContent = 
                        `(Cash: $${data.cash.toLocaleString(undefined, {maximumFractionDigits: 2})} + BTC: ${data.btcHoldings.toFixed(8)} × $${data.currentBtcPrice.toLocaleString(undefined, {maximumFractionDigits: 2})} = $${data.btcValue.toLocaleString(undefined, {maximumFractionDigits: 2})})`;
                    
                    const pnlSign = data.pnl >= 0 ? '+' : '';
                    const pnlPercentSign = data.pnlPercent >= 0 ? '+' : '';
                    document.getElementById('portfolio-pnl').textContent = 
                        `${pnlSign}$${data.pnl.toFixed(2)} (${pnlPercentSign}${data.pnlPercent.toFixed(2)}%)`;
                    
                    // Add to chart data
                    const now = new Date();
                    portfolioData.push({
                        time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        value: data.totalValue
                    });
                    
                    // Keep only last 48 points
                    if (portfolioData.length > 48) {
                        portfolioData.shift();
                    }
                }
            } catch (error) {
                console.error('Error loading portfolio data:', error);
            }
        }

        async function loadDecisionHistory() {
            try {
                const response = await fetch('/api/decisions');
                const data = await response.json();
                
                if (data.success) {
                    decisions = data.data;
                    populateDecisionHistory();
                }
            } catch (error) {
                console.error('Error loading decisions:', error);
            }
        }

        function initializeSimpleChart() {
            // Create a simple canvas-based chart since Chart.js is blocked
            const canvas = document.getElementById('portfolioChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            
            drawChart(ctx, canvas);
        }

        function drawChart(ctx, canvas) {
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Set chart background
            ctx.fillStyle = 'rgba(0, 255, 0, 0.05)';
            ctx.fillRect(0, 0, width, height);
            
            if (portfolioData.length < 2) {
                // Generate sample data if no real data yet
                for (let i = 0; i < 24; i++) {
                    const time = new Date(Date.now() - (23 - i) * 2 * 60 * 1000);
                    portfolioData.push({
                        time: time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        value: 10000 + i * 35 + (Math.random() - 0.5) * 200
                    });
                }
            }
            
            // Calculate min/max values
            const values = portfolioData.map(d => d.value);
            const minVal = Math.min(...values, 10000, 11000);
            const maxVal = Math.max(...values, 10000, 11000);
            const range = maxVal - minVal;
            
            // Draw grid lines
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i * (height - 2 * padding)) / 5;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                const value = maxVal - (i * range) / 5;
                ctx.fillStyle = '#00ff00';
                ctx.font = '12px Monaco';
                ctx.fillText('$' + Math.round(value).toLocaleString(), 5, y + 4);
            }
            
            // Vertical grid lines
            const step = Math.max(1, Math.floor(portfolioData.length / 8));
            for (let i = 0; i < portfolioData.length; i += step) {
                const x = padding + (i * (width - 2 * padding)) / (portfolioData.length - 1);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, height - padding);
                ctx.stroke();
                
                // X-axis labels
                ctx.fillStyle = '#00ff00';
                ctx.font = '10px Monaco';
                ctx.fillText(portfolioData[i].time, x - 15, height - 10);
            }
            
            // Draw baseline lines
            const baselineY = padding + ((maxVal - 10000) * (height - 2 * padding)) / range;
            const goalY = padding + ((maxVal - 11000) * (height - 2 * padding)) / range;
            
            // Initial capital line (red dashed)
            ctx.strokeStyle = '#ff0000';
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, baselineY);
            ctx.lineTo(width - padding, baselineY);
            ctx.stroke();
            
            // Goal line (blue dashed)
            ctx.strokeStyle = '#0099ff';
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(padding, goalY);
            ctx.lineTo(width - padding, goalY);
            ctx.stroke();
            
            // Draw portfolio value line
            ctx.strokeStyle = '#00ff00';
            ctx.setLineDash([]);
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            portfolioData.forEach((point, index) => {
                const x = padding + (index * (width - 2 * padding)) / (portfolioData.length - 1);
                const y = padding + ((maxVal - point.value) * (height - 2 * padding)) / range;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Fill area under curve
            ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
            ctx.beginPath();
            portfolioData.forEach((point, index) => {
                const x = padding + (index * (width - 2 * padding)) / (portfolioData.length - 1);
                const y = padding + ((maxVal - point.value) * (height - 2 * padding)) / range;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.lineTo(width - padding, height - padding);
            ctx.lineTo(padding, height - padding);
            ctx.closePath();
            ctx.fill();
        }

        function updateChart() {
            const canvas = document.getElementById('portfolioChart');
            const ctx = canvas.getContext('2d');
            drawChart(ctx, canvas);
        }

        function populateDecisionHistory() {
            const container = document.getElementById('decisions-container');
            container.innerHTML = ''; // Clear existing content
            
            if (decisions.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 20px;">Loading decision history...</div>';
                return;
            }
            
            decisions.forEach(decision => {
                const entry = createDecisionEntry(decision);
                container.appendChild(entry);
            });
        }

        function createDecisionEntry(decision) {
            const entry = document.createElement('div');
            entry.className = 'decision-entry';

            let detailsHtml = '';
            
            if (decision.action === 'BUY' || decision.action === 'SELL') {
                detailsHtml = `
                    <div class="decision-details">
                        <div><strong>Trade Details:</strong></div>
                        <div>• Entry Price: $${decision.entryPrice?.toLocaleString() || 'N/A'}</div>
                        <div>• Amount: ${decision.amount?.toFixed(8) || 'N/A'} BTC ($${decision.amountUsd?.toLocaleString() || 'N/A'})</div>
                        <div>• New Holdings: ${portfolio.btcHoldings.toFixed(8)} BTC</div>
                        <div>• Remaining Cash: $${portfolio.cash.toLocaleString()}</div>
                    </div>
                `;
            }

            const signalsHtml = decision.signals ? decision.signals.map(signal => 
                `<div>✅ ${signal}</div>`
            ).join('') : '';

            const additionalInfo = decision.confluence ? 
                `<div><br>Signal Confluence: ${decision.confluence}</div>
                 <div>Risk/Reward: ${decision.riskReward}</div>` : 
                (decision.decision ? `<div><br>Decision: ${decision.decision}</div>` : '');

            entry.innerHTML = `
                <div class="decision-header">
                    <div>
                        <span class="decision-type ${decision.action.toLowerCase()}">${decision.action}</span>
                        <span style="margin-left: 10px;">${decision.timestamp}</span>
                    </div>
                    <div class="confidence">Confidence: ${decision.confidence}%</div>
                </div>
                ${detailsHtml}
                <div class="decision-reasoning">
                    <strong>Reasoning:</strong><br>
                    ${decision.reasoning || 'No detailed reasoning provided'}
                    ${signalsHtml}
                    ${additionalInfo}
                </div>
            `;

            return entry;
        }

        async function loadMoreDecisions() {
            try {
                const offset = decisions.length;
                const response = await fetch(`/api/decisions?limit=10&offset=${offset}`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    decisions.push(...data.data);
                    
                    // Add new decisions to display
                    const container = document.getElementById('decisions-container');
                    data.data.forEach(decision => {
                        const entry = createDecisionEntry(decision);
                        container.appendChild(entry);
                    });
                    
                    // Hide load more button if no more data
                    if (!data.hasMore) {
                        document.querySelector('.load-more-btn').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading more decisions:', error);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>