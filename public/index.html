<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Trading Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ecf0f1;
            min-height: 100vh;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            text-align: center; padding: 30px; margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header h1 {
            font-size: 2.5rem; margin-bottom: 10px;
            background: linear-gradient(135deg, #2ecc71, #3498db);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .live-dot {
            display: inline-block; width: 12px; height: 12px;
            background: #2ecc71; border-radius: 50%;
            animation: pulse 2s infinite; margin-left: 10px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        
        .grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 15px; padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 20px; font-size: 1.2rem;
        }
        .card-icon { font-size: 1.4rem; color: #3498db; }
        .metric-value { font-size: 2rem; font-weight: 700; margin: 10px 0; }
        .metric-label {
            font-size: 0.9rem; color: #bdc3c7;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .positive { color: #2ecc71; }
        .negative { color: #e74c3c; }
        .neutral { color: #f39c12; }
        .chart-container { grid-column: 1 / -1; height: 400px; position: relative; }
        .status-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .status-item {
            display: flex; align-items: center; gap: 12px; padding: 15px;
            background: rgba(255, 255, 255, 0.05); border-radius: 10px;
            transition: all 0.3s ease;
        }
        .status-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-active { background: #2ecc71; }
        .status-limited { background: #f39c12; }
        .status-error { background: #e74c3c; }
        .controls {
            display: flex; justify-content: center; gap: 15px;
            margin: 30px 0; flex-wrap: wrap;
        }
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white; border: none; padding: 12px 25px;
            border-radius: 25px; cursor: pointer; font-size: 1rem;
            font-weight: 500; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 8px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }
        .decision-history { max-height: 600px; overflow-y: auto; }
        .decision-entry {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #3498db; padding: 20px;
            margin-bottom: 15px; border-radius: 10px;
            transition: all 0.3s ease;
        }
        .decision-entry:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        .decision-entry.buy { border-left-color: #2ecc71; }
        .decision-entry.sell { border-left-color: #e74c3c; }
        .decision-entry.neutral { border-left-color: #f39c12; }
        .decision-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 15px;
        }
        .decision-action {
            font-size: 1.2rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
        }
        .confidence-badge {
            padding: 6px 12px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 600;
            text-transform: uppercase;
        }
        .confidence-high { background: #2ecc71; color: white; }
        .confidence-medium { background: #f39c12; color: white; }
        .confidence-low { background: #e74c3c; color: white; }
        .timestamp { font-size: 0.9rem; color: #bdc3c7; font-style: italic; }
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 2rem; }
            .grid { grid-template-columns: 1fr; }
            .btn { width: 100%; max-width: 300px; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>
                <i class="fas fa-chart-line"></i>
                Real-time Bitcoin Trading Server
                <span class="live-dot"></span>
            </h1>
            <p>Advanced AI-Powered Market Intelligence & Automated Trading Dashboard</p>
            <div style="background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); border-radius: 8px; padding: 12px; margin: 15px 0; text-align: center; font-size: 0.9rem;">
                <i class="fas fa-shield-alt" style="color: #2ecc71; margin-right: 8px;"></i>
                <strong>🎯 EXECUTION AGENT: 5% Weekly Target | Real-time 1-min updates</strong>
            </div>
        </header>

        <div class="grid">
            <div class="card">
                <h3><i class="fab fa-bitcoin card-icon"></i> Bitcoin Price</h3>
                <div class="metric-value" id="current-price">Loading...</div>
                <div class="metric-label">USD</div>
                <div style="margin-top: 15px;">
                    <span class="metric-label">24h Change:</span>
                    <span class="metric-value" id="price-change" style="font-size: 1.2rem;">--</span>
                </div>
                <div class="timestamp" id="price-timestamp">--</div>
            </div>

            <div class="card">
                <h3><i class="fas fa-wallet card-icon"></i> Portfolio Status</h3>
                <div style="margin-bottom: 15px;">
                    <div class="metric-label">Total Value</div>
                    <div class="metric-value" id="portfolio-total">$0.00</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                    <div>
                        <div class="metric-label">Cash</div>
                        <div>$<span id="cash-balance">0.00</span></div>
                    </div>
                    <div>
                        <div class="metric-label">BTC Holdings</div>
                        <div><span id="btc-holdings">0.00000000</span></div>
                    </div>
                    <div>
                        <div class="metric-label">BTC Value</div>
                        <div>$<span id="btc-value">0.00</span></div>
                    </div>
                    <div>
                        <div class="metric-label">P&L</div>
                        <div class="metric-value" id="profit-loss" style="font-size: 1rem;">$0.00</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-robot card-icon"></i> Execution Agent Status</h3>
                <div id="agent-status" class="status-grid">
                    <div class="status-item">
                        <div class="status-dot status-active"></div>
                        <div>Loading agent status...</div>
                    </div>
                </div>
                
                <!-- Execution Agent Progress -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin-bottom: 15px; color: #3498db;">🎯 Weekly Target Progress</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                        <div>
                            <div class="metric-label">Current Return</div>
                            <div class="metric-value" id="current-return" style="font-size: 1.5rem;">--</div>
                        </div>
                        <div>
                            <div class="metric-label">Target: 5%</div>
                            <div class="metric-value" id="target-progress" style="font-size: 1.5rem;">--</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="metric-label">Progress Bar</div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 20px; overflow: hidden;">
                            <div id="progress-bar" style="background: linear-gradient(90deg, #2ecc71, #3498db); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-bar card-icon"></i> Performance</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                    <div>
                        <div class="metric-label">Success Rate</div>
                        <div class="metric-value" id="success-rate" style="font-size: 1.8rem;">--</div>
                    </div>
                    <div>
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value" id="total-trades" style="font-size: 1.8rem;">--</div>
                    </div>
                    <div>
                        <div class="metric-label">Avg. Return</div>
                        <div class="metric-value" id="avg-return" style="font-size: 1.5rem;">--</div>
                    </div>
                    <div>
                        <div class="metric-label">Total P&L</div>
                        <div class="metric-value" id="total-pnl" style="font-size: 1.5rem;">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card chart-container">
            <h3><i class="fas fa-chart-area card-icon"></i> Portfolio Performance</h3>
            <canvas id="portfolioChart"></canvas>
        </div>

        <div class="card">
            <h3><i class="fas fa-brain card-icon"></i> AI Decision History</h3>
            <div class="decision-history" id="decision-history">
                <div style="padding: 20px; text-align: center; color: #bdc3c7;">
                    Loading decision history...
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="downloadTrades()">
                <i class="fas fa-download"></i>
                Download Trade History
            </button>
            <button class="btn btn-success" onclick="exportPortfolio()">
                <i class="fas fa-file-export"></i>
                Export Portfolio
            </button>
        </div>
    </div>

    <script>
        let portfolioChart;
        let currentPrice = 0;
        let cashBalance = 0;  // Will be loaded from database
        let btcHoldings = 0;  // Will be loaded from database

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            initializeChart();
            refreshAllData();
            setInterval(refreshAllData, 60000); // 1 minute
        });

        function initializeChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(46, 204, 113, 0.4)');
            gradient.addColorStop(1, 'rgba(46, 204, 113, 0.05)');

            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#2ecc71',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#2ecc71',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }, {
                        label: 'Initial Capital ($10,000)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#ecf0f1' } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#bdc3c7' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#bdc3c7',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        async function refreshAllData() {
            console.log('Refreshing all data...');
            try {
                await Promise.all([
                    loadPriceData(),
                    loadAgentStatus(),
                    loadPortfolioData(),
                    loadPerformanceData(),
                    loadDecisionHistory(),
                    loadExecutionProgress()
                ]);
                document.getElementById('price-timestamp').textContent = 
                    new Date().toISOString().replace('T', ' ').slice(0, 19) + ' GMT (Updates every 1 minute)';
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        async function loadPriceData() {
            try {
                const response = await fetch('/api/bitcoin-price');
                const data = await response.json();
                
                if (data.success) {
                    currentPrice = data.data.price;
                    const change24h = data.data.change24h || 0;
                    
                    document.getElementById('current-price').textContent = 
                        '$' + currentPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    
                    const changeElement = document.getElementById('price-change');
                    changeElement.textContent = `${change24h > 0 ? '+' : ''}${change24h.toFixed(2)}%`;
                    changeElement.className = `metric-value ${change24h >= 0 ? 'positive' : 'negative'}`;
                    
                    updatePortfolioValue();
                } else {
                    document.getElementById('current-price').innerHTML = '<span class="negative">Error loading price</span>';
                }
            } catch (error) {
                document.getElementById('current-price').innerHTML = '<span class="negative">Connection error</span>';
            }
        }

        async function loadAgentStatus() {
            try {
                const response = await fetch('/api/agent-status');
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('agent-status');
                    container.innerHTML = Object.entries(data.data).map(([key, agent]) => `
                        <div class="status-item">
                            <div class="status-dot status-${agent.status}"></div>
                            <div>
                                <div style="font-weight: 600;">${agent.name}</div>
                                ${agent.note ? `<div style="font-size: 0.8rem; color: #bdc3c7;">${agent.note}</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('agent-status').innerHTML = 
                        '<div class="status-item"><div class="status-dot status-error"></div><div>System Error</div></div>';
                }
            } catch (error) {
                document.getElementById('agent-status').innerHTML = 
                    '<div class="status-item"><div class="status-dot status-error"></div><div>Connection Error</div></div>';
            }
        }

        async function loadPortfolioData() {
            try {
                const response = await fetch('/api/portfolio');
                const result = await response.json();
                
                if (result.success) {
                    const portfolio = result.data;
                    
                    // Update global variables with real data
                    btcHoldings = portfolio.btcHoldings || 0;
                    cashBalance = portfolio.usdBalance || 0;  // Start with 0 if no data
                    
                    // Update portfolio metrics display
                    updatePortfolioValue();
                    updatePortfolioChart();
                    updatePerformanceMetrics(portfolio.performance);
                } else {
                    console.error('Failed to load portfolio:', result.error);
                    // Keep existing display, don't update with bad data
                }
            } catch (error) {
                console.error('Error loading portfolio data:', error);
                // Keep existing display, don't update with bad data
            }
        }

        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/performance');
                const result = await response.json();
                
                if (result.success) {
                    const perf = result.data;
                    
                    // Update Success Rate
                    const successRateEl = document.getElementById('success-rate');
                    if (successRateEl) {
                        const rate = perf.successRate || 0;
                        successRateEl.textContent = rate.toFixed(1) + '%';
                        successRateEl.className = `metric-value ${rate >= 50 ? 'positive' : rate > 0 ? 'neutral' : 'negative'}`;
                    }
                    
                    // Update Total Trades
                    const totalTradesEl = document.getElementById('total-trades');
                    if (totalTradesEl) {
                        totalTradesEl.textContent = perf.totalTrades || 0;
                        totalTradesEl.className = 'metric-value';
                    }
                    
                    // Update Average Return
                    const avgReturnEl = document.getElementById('avg-return');
                    if (avgReturnEl) {
                        const avgReturn = perf.avgReturn || 0;
                        avgReturnEl.textContent = (avgReturn >= 0 ? '+' : '') + avgReturn.toFixed(2) + '%';
                        avgReturnEl.className = `metric-value ${avgReturn >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // Update Total P&L
                    const totalPnlEl = document.getElementById('total-pnl');
                    if (totalPnlEl) {
                        const profit = perf.totalProfit || 0;
                        totalPnlEl.textContent = (profit >= 0 ? '+$' : '-$') + Math.abs(profit).toLocaleString();
                        totalPnlEl.className = `metric-value ${profit >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    console.log('✅ Performance metrics loaded:', perf);
                } else {
                    console.error('Failed to load performance metrics:', result.error);
                    // Set default values for no data
                    setDefaultPerformanceValues();
                }
            } catch (error) {
                console.error('Error loading performance data:', error);
                setDefaultPerformanceValues();
            }
        }

        function setDefaultPerformanceValues() {
            const elements = {
                'success-rate': 'No data',
                'total-trades': '0',
                'avg-return': 'No data',
                'total-pnl': '$0.00'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = value;
                    el.className = 'metric-value';
                }
            });
        }

        function updatePerformanceMetrics(performance) {
            if (!performance) return;
            
            // Update win rate
            const winRateElement = document.querySelector('.grid .card:nth-child(3) .metric-value');
            if (winRateElement && performance.winRate !== undefined) {
                winRateElement.textContent = performance.winRate.toFixed(1) + '%';
                winRateElement.className = `metric-value ${performance.winRate >= 50 ? 'positive' : 'negative'}`;
            }
            
            // Update total trades
            const tradesElement = document.querySelector('.grid .card:nth-child(3) .metric-value');
            if (tradesElement && performance.totalTrades !== undefined) {
                // Find the second metric-value element for total trades
                const metrics = document.querySelectorAll('.grid .card:nth-child(3) .metric-value');
                if (metrics[1]) {
                    metrics[1].textContent = performance.totalTrades;
                }
            }
        }

        function updatePortfolioValue() {
            const btcValue = btcHoldings * currentPrice;
            const totalValue = cashBalance + btcValue;
            const initialCapital = 10000;
            const profitLoss = totalValue - initialCapital;
            const profitLossPercent = (profitLoss / initialCapital) * 100;

            document.getElementById('cash-balance').textContent = cashBalance.toFixed(2);
            document.getElementById('btc-holdings').textContent = btcHoldings.toFixed(8);
            document.getElementById('btc-value').textContent = btcValue.toFixed(2);
            document.getElementById('portfolio-total').textContent = 
                '$' + totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const plElement = document.getElementById('profit-loss');
            plElement.textContent = `${profitLoss >= 0 ? '+' : ''}$${profitLoss.toFixed(2)} (${profitLoss >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%)`;
            plElement.className = `metric-value ${profitLoss >= 0 ? 'positive' : 'negative'}`;
        }

        function updatePortfolioChart() {
            // Use real portfolio data only - no fake historical data
            const currentValue = cashBalance + (btcHoldings * currentPrice);
            const labels = [];
            const portfolioValues = [];
            const baselineValues = [];
            
            // Show minimal chart with current value only
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today.getTime() - (i * 24 * 3600000));
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                // Only show current value for today, empty for other days
                if (i === 0) {
                    portfolioValues.push(currentValue);
                } else {
                    portfolioValues.push(null); // No historical data
                }
                baselineValues.push(10000); // Starting capital baseline ($10k)
            }
            
            portfolioChart.data.labels = labels;
            portfolioChart.data.datasets[0].data = portfolioValues;
            portfolioChart.data.datasets[1].data = baselineValues;
            portfolioChart.update();
        }

        async function loadDecisionHistory() {
            try {
                const response = await fetch('/api/agent-logs?limit=10');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const decisions = result.data.filter(log => 
                        log.type === 'trading_decision' || 
                        log.type === 'market_analysis' ||
                        log.agent === 'bitcoin-orchestrator'
                    );
                    
                    const container = document.getElementById('decision-history');
                    
                    if (decisions.length === 0) {
                        container.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #bdc3c7;">
                                <i class="fas fa-clock"></i> No AI decisions recorded yet.<br>
                                <small>Agent decisions will appear here as they are made.</small>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = decisions.map(decision => {
                        const timestamp = new Date(decision.timestamp);
                        
                        // Use enhanced details if available
                        const details = decision.details || {};
                        const output = decision.output || {};
                        const input = decision.input || {};
                        const marketIntelligence = input.marketIntelligence || {};
                        const progressMetrics = input.progressMetrics || {};
                        
                        const action = details.action || output.action || 'ANALYZE';
                        const amount = details.amount || output.amount || 0;
                        const price = details.price || output.price || 0;
                        const confidence = details.confidence || output.confidence || 0;
                        const reasoning = details.reasoning || output.reasoning || decision.error || 'Processing market data...';
                        const urgency = details.urgency || output.urgency || 'NORMAL';
                        const progressPercent = details.progressPercent || progressMetrics.progressPercent || 'N/A';
                        const marketBasis = output.marketBasis || '';
                        
                        // Market Intelligence Data
                        const sentiment = marketIntelligence.sentiment || {};
                        const sentimentScore = sentiment.score || 0;
                        const sentimentOverall = sentiment.overall || 'unknown';
                        const newsCount = sentiment.newsCount || marketIntelligence.newsCount || 0;
                        const impactScore = marketIntelligence.impactScore || 0;
                        const trend = marketIntelligence.trend || 'unknown';
                        const volatility = marketIntelligence.volatility || 'unknown';
                        
                        // Progress Metrics
                        const currentReturn = progressMetrics.currentReturn ? (progressMetrics.currentReturn * 100).toFixed(2) : 'N/A';
                        const targetReturn = progressMetrics.targetReturn ? (progressMetrics.targetReturn * 100).toFixed(0) : '5';
                        const daysRemaining = progressMetrics.daysRemaining || 'N/A';
                        const isOnTrack = progressMetrics.isOnTrack;
                        const portfolioValue = input.portfolioValue ? '$' + input.portfolioValue.toFixed(2) : 'N/A';
                        
                        const confidenceClass = confidence >= 80 ? 'confidence-high' : 
                                              confidence >= 60 ? 'confidence-medium' : 'confidence-low';
                        
                        const actionIcon = action === 'BUY' ? '🟢' : 
                                         action === 'SELL' ? '🔴' : '🔍';
                        
                        const successIcon = decision.success ? '✅' : '❌';
                        
                        const urgencyIcon = urgency === 'HIGH' ? '🚨' : 
                                          urgency === 'MEDIUM' ? '⚠️' : '📊';

                        const sentimentIcon = sentimentOverall === 'positive' ? '📈' : 
                                            sentimentOverall === 'negative' ? '📉' : '📊';
                        
                        const trendIcon = trend === 'bullish' ? '🔥' : 
                                        trend === 'bearish' ? '❄️' : '⚖️';

                        return `
                            <div class="decision-entry ${action.toLowerCase()}">
                                <div class="decision-header">
                                    <div class="decision-action">
                                        ${actionIcon} ${action} ${successIcon} ${urgencyIcon}
                                    </div>
                                    <div class="timestamp">${timestamp.toISOString().replace('T', ' ').slice(0, 19)} GMT</div>
                                </div>
                                
                                <!-- Confidence & Progress Row -->
                                <div style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                    ${confidence > 0 ? `
                                        <span class="confidence-badge ${confidenceClass}">
                                            ${confidence}% Confidence
                                        </span>
                                    ` : ''}
                                    ${progressPercent !== 'N/A' ? `
                                        <span style="padding: 2px 8px; background: ${isOnTrack ? 'rgba(46, 204, 113, 0.2)' : 'rgba(241, 196, 15, 0.2)'}; border-radius: 4px; font-size: 0.8rem;">
                                            Progress: ${progressPercent}% ${isOnTrack ? '✅' : '⚠️'}
                                        </span>
                                    ` : ''}
                                    ${portfolioValue !== 'N/A' ? `
                                        <span style="padding: 2px 8px; background: rgba(155, 89, 182, 0.2); border-radius: 4px; font-size: 0.8rem;">
                                            Portfolio: ${portfolioValue}
                                        </span>
                                    ` : ''}
                                </div>

                                <!-- Market Intelligence Grid -->
                                ${newsCount > 0 || sentimentScore !== 0 || impactScore > 0 ? `
                                    <div style="margin: 15px 0; padding: 12px; background: rgba(52, 73, 94, 0.3); border-radius: 8px; border-left: 3px solid #3498db;">
                                        <div style="font-weight: 600; margin-bottom: 8px; color: #3498db;">
                                            🧠 Market Intelligence Analysis
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 0.85rem;">
                                            ${newsCount > 0 ? `
                                                <div>
                                                    <strong>📰 News:</strong> ${newsCount} items
                                                </div>
                                            ` : ''}
                                            ${sentimentScore !== 0 ? `
                                                <div>
                                                    <strong>${sentimentIcon} Sentiment:</strong> ${sentimentOverall} (${sentimentScore.toFixed(3)})
                                                </div>
                                            ` : ''}
                                            ${impactScore > 0 ? `
                                                <div>
                                                    <strong>💥 Impact:</strong> ${impactScore}/100
                                                </div>
                                            ` : ''}
                                            ${trend !== 'unknown' ? `
                                                <div>
                                                    <strong>${trendIcon} Trend:</strong> ${trend}
                                                </div>
                                            ` : ''}
                                            ${volatility !== 'unknown' ? `
                                                <div>
                                                    <strong>📊 Volatility:</strong> ${volatility}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Decision Details -->
                                <div style="margin: 10px 0;">
                                    <div style="font-weight: 600; margin-bottom: 5px;">Agent: ${decision.agent}</div>
                                    <div style="margin-bottom: 8px;">${reasoning}</div>
                                    
                                    ${marketBasis ? `
                                        <div style="padding: 8px; background: rgba(230, 126, 34, 0.15); border-radius: 6px; font-size: 0.85rem; margin-top: 8px;">
                                            <strong>📊 Market Basis:</strong> ${marketBasis}
                                        </div>
                                    ` : ''}
                                    
                                    ${amount > 0 && price > 0 ? `
                                        <div style="margin-top: 8px; font-size: 0.9rem; color: #3498db;">
                                            Amount: ${amount.toFixed(4)} BTC @ $${price.toFixed(2)} (${(amount * price).toFixed(2)} USD)
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- Performance Metrics -->
                                ${currentReturn !== 'N/A' || daysRemaining !== 'N/A' ? `
                                    <div style="margin: 12px 0; padding: 10px; background: rgba(46, 204, 113, 0.1); border-radius: 6px;">
                                        <div style="font-weight: 600; margin-bottom: 6px; color: #27ae60;">
                                            🎯 Performance Tracking
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 0.8rem;">
                                            ${currentReturn !== 'N/A' ? `
                                                <div><strong>Current:</strong> ${currentReturn}%</div>
                                            ` : ''}
                                            <div><strong>Target:</strong> ${targetReturn}%</div>
                                            ${daysRemaining !== 'N/A' ? `
                                                <div><strong>Days Left:</strong> ${daysRemaining}</div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${output.signals ? `
                                    <div style="margin-top: 8px;">
                                        <div style="font-size: 0.85rem; color: #95a5a6;">
                                            Signals: ${output.signals.join(', ')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    ${decision.executionTime ? `Execution: ${decision.executionTime}ms | ` : ''}
                                    Urgency: ${urgency} | ID: ${decision.id}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // No real data available yet
                    document.getElementById('decision-history').innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #bdc3c7;">
                            <i class="fas fa-robot"></i> AI Trading Engine Initializing...<br>
                            <small>Agents are analyzing market conditions. Decisions will appear here shortly.</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading decision history:', error);
                document.getElementById('decision-history').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle"></i> Unable to load decision history<br>
                        <small>Check server connection</small>
                    </div>
                `;
            }
        }

        async function generateContent() {
            try {
                const response = await fetch('/api/generate-content');
                const data = await response.json();
                
                if (data.success) {
                    alert(`Content Generated!\n\nDaily Summary: ${data.data.dailySummary || 'Generated successfully'}\n\nPrice Alert: ${data.data.priceAlert || 'Alert created'}`);
                } else {
                    alert('Error generating content: ' + data.error);
                }
            } catch (error) {
                alert('Error generating content. Please check the connection.');
            }
        }

        async function loadExecutionProgress() {
            try {
                const response = await fetch('/api/execution-progress');
                const result = await response.json();
                
                if (result.success) {
                    const progress = result.data;
                    
                    // Update current return
                    const currentReturnEl = document.getElementById('current-return');
                    if (currentReturnEl) {
                        const returnPercent = (progress.currentReturn * 100).toFixed(2);
                        currentReturnEl.textContent = (progress.currentReturn >= 0 ? '+' : '') + returnPercent + '%';
                        currentReturnEl.className = `metric-value ${progress.currentReturn >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // Update target progress
                    const targetProgressEl = document.getElementById('target-progress');
                    if (targetProgressEl) {
                        targetProgressEl.textContent = progress.progressPercent + '%';
                        targetProgressEl.className = `metric-value ${progress.onTrack ? 'positive' : 'negative'}`;
                    }
                    
                    // Update progress bar
                    const progressBarEl = document.getElementById('progress-bar');
                    if (progressBarEl) {
                        const progressWidth = Math.min(Math.max(parseFloat(progress.progressPercent), 0), 100);
                        progressBarEl.style.width = progressWidth + '%';
                        
                        // Change color based on progress
                        if (progressWidth >= 100) {
                            progressBarEl.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)'; // Green when target met
                        } else if (progressWidth >= 50) {
                            progressBarEl.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)'; // Orange when halfway
                        } else {
                            progressBarEl.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)'; // Red when behind
                        }
                    }
                    
                    console.log('✅ Execution progress loaded:', progress);
                } else {
                    console.error('Failed to load execution progress:', result.error);
                }
            } catch (error) {
                console.error('Error loading execution progress:', error);
            }
        }

        // Download Functions - Real Data Only
        async function downloadTrades() {
            try {
                const response = await fetch('/api/trade-history');
                
                if (!response.ok) {
                    throw new Error('Unable to fetch trade history from server');
                }
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch trade data');
                }
                
                const trades = result.data;
                
                if (!trades || trades.length === 0) {
                    alert('No trade history available yet. Start trading to see data here.');
                    return;
                }
                
                // Convert to CSV format
                const csvContent = convertTradesToCSV(trades);
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bitcoin_trades_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                alert(`Trade history downloaded successfully! (${trades.length} trades)`);
            } catch (error) {
                alert('Error downloading trade history: ' + error.message);
                console.error('Download error:', error);
            }
        }

        async function exportPortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                
                if (!response.ok) {
                    throw new Error('Unable to fetch portfolio from server');
                }
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch portfolio data');
                }
                
                const portfolio = result.data;
                
                // Create comprehensive portfolio report
                const reportContent = generatePortfolioReport(portfolio);
                
                // Create download link
                const blob = new Blob([reportContent], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bitcoin_portfolio_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                alert('Portfolio exported successfully!');
            } catch (error) {
                alert('Error exporting portfolio: ' + error.message);
                console.error('Export error:', error);
            }
        }

        // Helper Functions for Data Processing
        function convertTradesToCSV(trades) {
            const headers = ['Date', 'Type', 'Amount (BTC)', 'Price (USD)', 'Fee (USD)', 'Total (USD)', 'Reason'];
            const csvRows = [headers.join(',')];
            
            trades.forEach(trade => {
                const row = [
                    trade.date,
                    trade.type,
                    trade.amount,
                    trade.price,
                    trade.fee || 0,
                    trade.total,
                    (trade.reason || '').replace(/,/g, ';') // Remove commas to avoid CSV issues
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        function generatePortfolioReport(portfolio) {
            const performance = portfolio.performance || {};
            const recentTrades = portfolio.recentTrades || [];
            
            return JSON.stringify({
                exportDate: new Date().toISOString(),
                portfolio: {
                    btcHoldings: portfolio.btcHoldings || 0,
                    usdBalance: portfolio.usdBalance || 0,
                    totalValue: portfolio.totalValue || 0,
                    totalProfit: portfolio.totalProfit || 0,
                    profitPercentage: portfolio.profitPercentage || 0,
                    lastUpdated: portfolio.lastUpdated
                },
                performance: {
                    totalTrades: performance.totalTrades || 0,
                    totalProfit: performance.totalProfit || 0,
                    avgTradeSize: performance.avgTradeSize || 0,
                    winRate: performance.winRate || 0,
                    dailyVolume: performance.dailyVolume || 0
                },
                recentTrades: recentTrades,
                summary: {
                    exportTimestamp: new Date().toISOString(),
                    tradingActive: recentTrades.length > 0,
                    lastTradeDate: recentTrades.length > 0 ? recentTrades[0].timestamp : null
                }
            }, null, 2);
        }

        // Execution Agent Progress Tracking
        async function loadExecutionProgress() {
            try {
                const response = await fetch('/api/execution-progress');
                const result = await response.json();
                
                if (result.success) {
                    const progress = result.data;
                    
                    // Update current return
                    const currentReturnEl = document.getElementById('current-return');
                    if (currentReturnEl) {
                        const returnPercent = (progress.currentReturn * 100).toFixed(2);
                        currentReturnEl.textContent = (progress.currentReturn >= 0 ? '+' : '') + returnPercent + '%';
                        currentReturnEl.className = `metric-value ${progress.currentReturn >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // Update target progress
                    const targetProgressEl = document.getElementById('target-progress');
                    if (targetProgressEl) {
                        targetProgressEl.textContent = progress.progressPercent + '%';
                        targetProgressEl.className = `metric-value ${progress.onTrack ? 'positive' : 'negative'}`;
                    }
                    
                    // Update progress bar
                    const progressBarEl = document.getElementById('progress-bar');
                    if (progressBarEl) {
                        const progressWidth = Math.min(Math.max(parseFloat(progress.progressPercent), 0), 100);
                        progressBarEl.style.width = progressWidth + '%';
                        
                        // Change color based on progress
                        if (progressWidth >= 100) {
                            progressBarEl.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
                        } else if (progressWidth >= 50) {
                            progressBarEl.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
                        } else {
                            progressBarEl.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                        }
                    }
                    
                    console.log('✅ Execution progress loaded:', progress);
                } else {
                    console.error('Failed to load execution progress:', result.error);
                }
            } catch (error) {
                console.error('Error loading execution progress:', error);
            }
        }
    </script>
</body>
</html>